<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>csv2geojson</title>
  <script src="js/jquery-3.2.1.min.js" type="text/javascript"></script>
  <script src="js/jquery.csv.min.js"></script>

  <style>
    textarea {
      width: 550px;
      height: 150px;
    }
  </style>
</head>
<body>
  <h1>csv2geojson</h1>
  <form name="import">
    <label>上下のテキストエリアにデータがある場合は下のエリアが優先されます</label><br>
    <input type="file" id="csvfile"><br>
    <textarea id="csvfiledata" name="csvfiledata" spellcheck="false">Put CSV here.</textarea><br>
    <label>もしくは、直接入力してください</label><br>
    <textarea id="csvdata" spellcheck="false"></textarea><br>
  </form><br>

  <button type="button" id="cfm">確認する</button><br><br>
  <div class="result">
    <table id="result2" border="1"></table>
  </div>

  <label><input type="checkbox" id="beauty">Beauty Print?</label><br /><br />
  <button type="button" id="convert">変換する</button><br><br>

  <form name="export">
    <textarea id="geojson" readonly spellcheck="false"></textarea><br>
    <button type="button" id="copy">コピーする</button>
  </form><br>

  <button type="button">ダウンロードする</button><br><br>



  <script>
    var obj1 = document.getElementById("csvfile");
    //ダイアログでファイルが選択された時
    obj1.addEventListener("change",function(evt){
      var file = evt.target.files;
      //FileReaderの作成
      var reader = new FileReader();
      //テキスト形式で読み込む
      reader.readAsText(file[0]);
      //読込終了後の処理
      reader.onload = function(ev){
        //テキストエリアに表示する
        document.import.csvfiledata.value = reader.result;
        csv2table();//それぞれの関数の実行
      }
    },false);
  </script>
  <script>
    // String.prototype.trim = function() {
    //   return this.replace(/^\s+|\s+$/g,"");
    // }

      $('#cfm').bind('click', function() {
        csv2table();//それぞれの関数の実行
      });

    function csv2table() {
      if (document.getElementById("csvfiledata").value != "" && document.getElementById("csvdata").value != "") {
        input = $("#csvdata").val();
      } else if (document.getElementById("csvfiledata").value != "" && document.getElementById("csvdata").value == "") {
        input = $("#csvfiledata").val();
      } else if (document.getElementById("csvfiledata").value == "" && document.getElementById("csvdata").value != "") {
        input = $("#csvdata").val();
      } else {
        return null;
      }

      var data = $.csv.toArrays(input);
      var html = generateTable(data);
      $('#result2').empty();
      $('#result2').html(html);
    }

    // build HTML table data from an array (one or two dimensional)
    function generateTable(data) {
      var html = '';

      if(typeof(data[0]) === 'undefined') {
        return null;
      }

      if(data[0].constructor === String) {
        html += '<tr>\r\n';
        for(var item in data) {
          html += '<td>' + data[item] + '</td>\r\n';
        }
        html += '</tr>\r\n';
      }

      if(data[0].constructor === Array) {
        for(var row in data) {
          html += '<tr>\r\n';
          for(var item in data[row]) {
            html += '<td>' + data[row][item] + '</td>\r\n';
          }
          html += '</tr>\r\n';
        }
      }

      if(data[0].constructor === Object) {
        for(var row in data) {
          html += '<tr>\r\n';
          for(var item in data[row]) {
            html += '<td>' + item + ':' + data[row][item] + '</td>\r\n';
          }
          html += '</tr>\r\n';
        }
      }

      return html;
    }
  </script>
  <script>
    $('#copy').bind('click', function() {
      var geojsoncopy = document.getElementById("geojson");
      geojsoncopy.select();
      document.execCommand("copy");
      alert('コピーしました');
    });
  </script>
  <script src="js/libs/geojson.min.js"></script>
  <script src="js/libs/CsvToJson.js"></script>
  <script src="js/app.js"></script>
</body>
</html>